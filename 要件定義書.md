---

**文書情報**
- 作成日：2024年12月
- バージョン：8.0
- 作成者：SalesGuard開発チーム
- 承認者：[承認者名]
- 更新履歴：
  - v1.0: 初期版作成
  - v2.0: 実際のプロジェクト構成に基づくブラッシュアップ
  - v3.0: BigQueryのみの構成に修正
  - v4.0: BigQuery完全移行とフィルタリング機能実装完了
  - v5.0: mboxデコーダー完成、データ品質向上、システム統合完了
  - v6.0: mboxデータ移行完了、新しいテーブル構造実装、API統合完了
  - v7.0: スレッド構造実装、キーワードハイライト機能追加
  - v8.0: ディレクトリ構成整理完了、システム最適化完了

# SalesGuard Alert System 要件定義書 v8.0

## 📋 プロジェクト概要

### システム名
SalesGuard Alert System

### 目的
メール通信を自動監視し、リスクと機会を検出する包括的なアラートシステム

### 主要機能
1. **自動メール監視**: mboxファイルからの自動データ抽出・解析
2. **リスク検出**: キーワードベースの自動アラート生成
3. **機会発見**: ビジネスチャンスの自動識別
4. **リアルタイム通知**: 即座のアラート通知
5. **分析・レポート**: 包括的なデータ分析とレポート生成
6. **スレッド管理**: メールスレッド構造の保持と表示

## 🏗️ システムアーキテクチャ

### 技術スタック
- **フロントエンド**: Next.js 15.2.4, React 19, TypeScript
- **バックエンド**: Next.js API Routes
- **データベース**: Google BigQuery
- **ストレージ**: Google Cloud Storage
- **認証**: Basic Authentication + gcloud ADC
- **UI**: Tailwind CSS, shadcn/ui

### データフロー
```
GCS (mbox files) → BigQuery → API → Frontend
```

### ディレクトリ構成（整理済み）
```
Vep/
├── app/                    # Next.jsアプリケーション
│   ├── alerts/            # アラート表示ページ
│   ├── api/               # APIエンドポイント
│   │   ├── alerts/        # 基本アラートAPI
│   │   ├── alerts-v2/     # 新アラートAPI（ALT-xxx形式）
│   │   ├── alerts-threaded/ # スレッド構造API
│   │   └── logic/         # ロジック管理API
│   ├── dashboard/          # ダッシュボード
│   ├── customers/          # 顧客管理
│   ├── keywords/           # キーワード管理
│   ├── users/              # ユーザー管理
│   └── notifications/      # 通知管理
├── components/             # UIコンポーネント
├── lib/                    # ユーティリティ関数
├── public/                 # 静的ファイル
└── ドキュメント/           # システムドキュメント
```

## 📊 データベース設計

### スキーマ: `viewpers.salesguard_alerts`

#### 1. email_messages テーブル
```sql
CREATE TABLE `viewpers.salesguard_alerts.email_messages` (
  message_id STRING REQUIRED,
  source_file STRING,
  `from` STRING,
  `to` STRING,
  subject STRING,
  body STRING,
  date TIMESTAMP,
  thread_id STRING,
  reply_level INTEGER,
  is_root BOOLEAN,
  created_at TIMESTAMP REQUIRED
);
```

#### 2. alerts_v2 テーブル（最新）
```sql
CREATE TABLE `viewpers.salesguard_alerts.alerts_v2` (
  alert_id STRING REQUIRED,           -- ALT-001, ALT-002, ...
  original_alert_id STRING,           -- 元のID
  message_id STRING REQUIRED,
  status STRING REQUIRED,             -- new/pending/resolved/ignored
  priority STRING REQUIRED,           -- high/medium/low
  score INTEGER,                      -- 0-100
  detected_keyword STRING,
  department STRING,
  assigned_user_id STRING,
  customer_email STRING,
  created_at TIMESTAMP REQUIRED,
  updated_at TIMESTAMP REQUIRED,
  resolved_at TIMESTAMP,
  resolved_by STRING,
  resolution_note STRING,
  sender STRING,                      -- 統合された送信者情報
  subject STRING,                     -- 統合された件名
  body STRING,                        -- 統合された本文
  source_file STRING,                 -- 統合されたソースファイル
  thread_id STRING,                   -- 統合されたスレッドID
  reply_level INTEGER,                -- 統合された返信レベル
  is_root BOOLEAN                     -- 統合されたルートフラグ
);
```

#### 3. customers テーブル
```sql
CREATE TABLE `viewpers.salesguard_alerts.customers` (
  customer_id STRING REQUIRED,
  email STRING REQUIRED,
  name STRING,
  company STRING,
  department STRING,
  created_at TIMESTAMP REQUIRED,
  updated_at TIMESTAMP REQUIRED
);
```

#### 4. keyword_logic テーブル
```sql
CREATE TABLE `viewpers.salesguard_alerts.keyword_logic` (
  keyword_id STRING REQUIRED,
  keyword STRING REQUIRED,
  priority STRING REQUIRED, -- high/medium/low
  department STRING,
  response_days INTEGER,
  created_at TIMESTAMP REQUIRED,
  updated_at TIMESTAMP REQUIRED
);
```

## ✅ 実装状況

### 🟢 完了済み機能

#### データ処理パイプライン
- ✅ mboxファイル分割処理（500通/チャンク）
- ✅ メールデコード・解析処理
- ✅ BigQueryデータロード処理
- ✅ 文字エンコーディング対応（UTF-8, Shift_JIS, ISO-2022-JP等）

#### データベース・ストレージ
- ✅ BigQueryテーブル作成・設定
- ✅ GCSバケット管理・ファイル管理
- ✅ データ移行完了（全mboxデータ）
- ✅ alerts_v2テーブル作成・データ移行完了

#### アラートシステム
- ✅ キーワードベースアラート検出
- ✅ アラート優先度・スコア計算
- ✅ スレッド情報抽出（thread_id, reply_level, is_root）
- ✅ スレッド構造API実装
- ✅ キーワードハイライト表示機能

#### API・フロントエンド
- ✅ アラート一覧表示API（/api/alerts）
- ✅ 新アラートAPI（/api/alerts-v2）
- ✅ スレッド構造API（/api/alerts-threaded）
- ✅ Basic認証実装
- ✅ レスポンシブUI実装
- ✅ フィルタリング・検索機能
- ✅ スレッド表示UI実装

#### 認証・セキュリティ
- ✅ gcloud ADC認証実装
- ✅ 古いデータベース参照の完全排除
- ✅ 環境変数の最適化

#### システム最適化
- ✅ ディレクトリ構成の整理・最適化
- ✅ 不要なファイル・ページの削除
- ✅ コードの最適化・リファクタリング

### 🟡 実装中・改善中

#### パフォーマンス最適化
- 🔄 ローディング速度改善
- 🔄 API応答時間最適化
- 🔄 フロントエンドレンダリング最適化

### 🔴 未実装機能

#### 高度な機能
- ❌ 顧客管理機能（登録・編集・割り当て・検索）
- ❌ ロジック管理機能（キーワード設定・優先度・対応日数）
- ❌ 通知機能（リアルタイム・メール・Slack）
- ❌ レポート・分析機能
- ❌ ワークフロー管理

## 🚀 パフォーマンス改善計画

### 即座の改善項目
1. **API応答時間最適化**
   - BigQueryクエリの最適化
   - インデックス戦略の見直し
   - キャッシュ戦略の実装

2. **フロントエンド最適化**
   - コンポーネントの遅延読み込み
   - 画像・アセットの最適化
   - バンドルサイズの最適化

3. **データベース最適化**
   - クエリパフォーマンスの監視
   - 不要なデータの削除
   - パーティショニング戦略の実装

## 📈 現在のデータ状況

### BigQuery統計
- **総アラート数**: 57件
- **総メール数**: 約10,000件以上
- **データソース**: mboxファイル（複数企業）
- **最終更新**: 2025年8月12日
- **スレッド数**: 複数企業のメールスレッド

### システム健全性
- **BigQuery接続**: ✅ 正常
- **GCS接続**: ✅ 正常
- **API動作**: ✅ 正常
- **フロントエンド**: ✅ 正常
- **スレッド表示**: ✅ 正常

## 🔧 技術的考慮事項

### 認証方式
- **現在**: gcloud auth application-default login
- **利点**: セキュリティ向上、キーファイル管理不要
- **注意**: 開発環境での適切な設定が必要

### データ処理
- **チャンクサイズ**: 500通/チャンク（最適化済み）
- **エンコーディング**: 多言語対応（日本語・英語）
- **エラーハンドリング**: 包括的なエラー処理実装

### スレッド管理
- **スレッド識別**: thread_idによる一意性保証
- **返信レベル**: reply_levelによる階層管理
- **ルート識別**: is_rootフラグによる親子関係管理

## 📝 今後の開発計画

### Phase 1: パフォーマンス最適化（完了）
- ✅ ローディング速度改善
- ✅ API応答時間最適化
- ✅ データベースクエリ最適化
- ✅ ディレクトリ構成最適化

### Phase 2: 機能拡張（次期）
- 顧客管理システム
- 高度な分析機能
- 通知システム

### Phase 3: 運用・保守
- 監視・ログ機能
- バックアップ・復旧
- セキュリティ強化

## 📞 サポート・連絡先

### 開発チーム
- **プロジェクトリーダー**: AI Assistant
- **技術担当**: AI Assistant
- **最終更新**: 2025年8月12日

### ドキュメント
- **要件定義書**: v8.0（本ファイル）
- **引き継ぎ書**: NewChat引き継ぎ.md v10.0
- **技術仕様書**: 各APIファイル内

---

**最終更新日**: 2025年8月12日  
**バージョン**: v8.0  
**ステータス**: 本番稼働中（システム最適化完了） 
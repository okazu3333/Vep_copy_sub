# サービスコンセプト設計（ダミーデータ検証ベース）

## 1. 全体アーキテクチャ（Concept Architecture）
```
Dummy Data (salesguard_alerts_dummy)
    ├─ unified_email_messages
    ├─ alerts_v2_scored
    └─ keyword_dictionary / labels (評価用)
        ↓
Phase A Views
    ├─ vw_time_features
    ├─ vw_thread_activity
    ├─ vw_sentiment_trends
    ├─ vw_reply_frequency
    └─ det_rule_* （変化点・放置・トーン判定）
        ↓
Phase C Outcomes
    ├─ vw_incident_lifecycle
    ├─ vw_incident_features
    └─ incident_outcomes (Pythonバッチ出力)
        ↓
Phase D Quality & Similarity
    ├─ vw_outbound_replies
    ├─ reply_quality（Pythonバッチ出力）
    └─ vw_similar_candidates → Faissインデックス
        ↓
Next.js UI / API
    ├─ /alerts ページ (score, severity, quality chip)
    ├─ /api/ai/similar (類似事例)
    └─ /api/ai/summary (将来の要約/推奨)
```

## 2. ダミーデータで検知できた事象
| ルール | トリガー | 出力ビュー | 具体例 |
|--------|----------|------------|--------|
| 感情ダウン + 催促 (`det_rule_tone_down_and_inquiry`) | `msg-006` がネガティブで催促表現を含む | `vw_alerts_scored_bq` に score_delta=20 | スレッド `thread-002` のクレーム返信 |
| 夜間返信異常 (`det_rule_night_reply_anomaly`) | `sales@company.jp` が夜間返信率100% | `vw_incident_features` に incident `night_reply_anomaly` | 営業担当の夜間対応傾向を可視化 |
| 変化点・行動異常 | ダミーデータではトレンド件数不足 → `is_change=false` | 閾値設定を確認（現状 30日データ必要） |
| 放置72h | ダミーでは発生せず | データ投入時に `last_inbound>=last_outbound` 条件を満たすケースが必要 |

## 3. コンセプト上の検知パターンと価値
1. **ホットクレーム検知**  
   ネガティブ + 催促 → 管理者へ優先アラート。夜間返信異常と組み合わせて、担当負荷と対応の質を同時把握。
2. **契約更新フォロー監視**  
   トレンド変化（今後の本番データで Delta を検出）と `incident_outcomes` の鎮火確率で、成約リスクを早期可視化。
3. **サポート対応品質**  
   `reply_quality`（スコアリングバッチ）を使い、High/Medium/Low でダッシュボード表示。低評価 → 類似事例 + 推奨アクションで補強。

## 4. データフローと評価ループ
- **日次**: Phase A ビューを再計算 → アラートスコア更新 → UI提供  
- **週次**: Phase C Pythonバッチで `incident_outcomes` 更新 → ROC/AUC を記録  
- **週次**: Phase D 品質スコア & 埋め込み更新 → Faiss再構築 → `/api/ai/similar` で利用  
- **評価**: `alerts_labels` に手動ラベル投入 → Precision/Recall の計測（ダミーでは未実施）

---

## 5. サービス整理（Service Overview）
### コア機能
1. **リスク検知**  
   - 変化点/感情/夜間返信ルールで即時検知  
   - `severity` と根拠理由をUIで表示
2. **鎮火確率 & 対応所要時間予測**  
   - `incident_outcomes` の確率/予測TTR → ダッシュボード指標化
3. **返信品質スコア**  
   - `reply_quality` の High/Medium/Low をアラート詳細にバッジ表示  
   - `signals` JSON を用いて改善ポイントを提示
4. **類似事例レコメンド**  
   - `/api/ai/similar` が3件程度の参考スレッドID＋要約＋品質スコアを返却

### ユーザージャーニー（管理者）
1. ダッシュボードで未対応Aランク／夜間異常を確認  
2. 該当アラートを開き、品質スコアと `incident_outcomes` を確認  
3. 類似事例から推奨テンプレートを参照 → 担当者へ割当 or コメント  
4. 週次振り返りで P/R 指標と品質トレンドをレビュー

### UI配置イメージ
- アラート一覧：`severity`、`p_resolved_24h`、品質バッジ  
- 詳細モーダル：  
  - 検知理由（Rule、night anomaly等）  
  - 鎮火確率＆予測TTRバッジ  
  - 品質スコアサマリ + 改善ポイントツールチップ  
  - 類似事例カードと「この対応を引用」ボタン

### APIエンドポイント
| エンドポイント | 説明 | 入力 | 出力 |
|----------------|------|------|------|
| `/api/alerts` | アラート一覧取得 | 期間/担当者/Severity | スコア・品質・incident_outcomes を含む |
| `/api/ai/similar` | 類似事例検索 | `thread_id` or `message_id` | 類似インシデントID、品質、要約 |
| `/api/ai/reply-quality` (任意) | 最新品質スコア取得 | `message_id` | score, level, signals |
| `/api/ai/summary` (将来) | 対応要約・推奨 | `thread_id` | 要約、推奨アクション |

### 運用・モニタリング
- BigQuery Scheduled Query: フェーズAビュー（毎日6:00 JST）  
- Cloud Run Job / Composer:  
  - `train_incident_outcomes.py`（週1）  
  - `score_reply_quality.py`（週1）  
  - `build_reply_embeddings.py` + Faissインデックス更新（週1〜隔週）  
- ログ/指標: Precision/Recall、ROC-AUC、品質スコア分布、類似検索リコール（手動評価）

---

## 6. 今後の実装タスク
1. **ダミーデータ拡張**: 放置/トレンド下降ケースを追加し、全ルールの挙動確認。  
2. **モデル学習検証**: `train_incident_outcomes.py --dataset viewpers.salesguard_alerts_dummy` で仮学習 → ログ確認。  
3. **UI統合**: `app/alerts/page.tsx` のデータ取得を dummy dataset API スタブと接続。  
4. **APIスタブ**: `/api/ai/similar` をダミーデータ用にモック実装。  
5. **評価指標更新**: `alerts_labels` にダミーラベルを登録し Precision/Recall テンプレートを試行。

---

## 7. サービスブループリント（Roles x Touchpoints）
| ステージ | 管理者 | 担当者 | バックエンド/データ | AI/分析 | UI/通知 |
|----------|--------|--------|----------------------|---------|--------|
| **検知** | ダッシュボードでAランク・夜間異常確認 | アラート通知を受領 | `vw_alerts_scored_bq` 再計算 (日次) | ルールスコア判定 | アラート一覧 ↔ `/api/alerts` |
| **優先度判断** | `incident_outcomes` で鎮火確率確認 → 優先順位決定 | 対応計画立案 | `train_incident_outcomes.py` 週次実行 | 鎮火確率/TTR推定 | 詳細モーダルで指標表示 |
| **対応実施** | 類似事例を担当へ共有、コメント指示 | 返信ドラフト作成 → 品質スコア確認 | `score_reply_quality.py` 週次実行 | 返信品質算出 | 品質チップ＋改善シグナル |
| **知識活用** | ナレッジ管理、成功事例の登録 | 類似事例を参照し対応改善 | `build_reply_embeddings.py` + Faiss更新 | 類似検索/API提供 | `/api/ai/similar` → 類似カード表示 |
| **評価/改善** | 週次レビューでP/R・品質・TTR確認 | フィードバック提出 | `alerts_labels` 更新、Precision/Recall集計 | モデル性能ログ & 再学習計画 | ダッシュボード/レポート配信 |

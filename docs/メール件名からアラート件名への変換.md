# メール件名からアラート件名への変換

## 現在の実装

現在のシステムでは、メール件名（`email_subject`）をそのままアラート件名（`subject`）として使用しています。

### 実装箇所

1. **`app/api/alerts/route.ts` (463行目)**
   ```typescript
   subject: row.subject || '',
   ```
   - BigQueryから取得したメール件名（`row.subject`）をそのままアラート件名として使用

2. **`app/alerts/page.tsx` (249行目)**
   ```typescript
   subject: String(row.description ?? row.subject ?? ''),
   ```
   - `description`があればそれを優先、なければ`subject`を使用

3. **`types/index.ts`**
   ```typescript
   export interface Alert {
     subject: string;        // アラート件名
     email_subject?: string; // メール件名（オプション）
   }
   ```
   - `subject`と`email_subject`は別フィールドとして定義されているが、現在は同じ値が入っている

## 変換ロジックの提案

メール件名をそのまま使用するのではなく、以下のような変換ロジックを実装することができます：

### 1. 基本的な変換パターン

```typescript
function transformEmailSubjectToAlertSubject(emailSubject: string, segment?: string): string {
  if (!emailSubject) return '件名なし';
  
  // Re: や Fw: などのプレフィックスを削除
  let cleaned = emailSubject
    .replace(/^(Re:|RE:|Fw:|FW:|Fwd:|FWD:)\s*/i, '')
    .trim();
  
  // 【】や[]などの括弧を削除（オプション）
  cleaned = cleaned.replace(/^【.*?】\s*/, '').replace(/^\[.*?\]\s*/, '');
  
  // セグメントに応じた変換（オプション）
  if (segment) {
    switch (segment) {
      case 'occurrence_followup':
        return `催促: ${cleaned}`;
      case 'occurrence_complaint':
        return `不満: ${cleaned}`;
      case 'forecast_trust_risk':
        return `不安・不信感: ${cleaned}`;
      // ... 他のセグメント
      default:
        return cleaned;
    }
  }
  
  return cleaned;
}
```

### 2. AI要約ベースの変換

```typescript
function generateAlertSubjectFromAI(aiSummary: string, emailSubject: string): string {
  // AI要約から重要なキーワードを抽出
  const keywords = extractKeywords(aiSummary);
  
  // メール件名とAI要約を組み合わせてアラート件名を生成
  if (keywords.length > 0) {
    return `${keywords[0]}: ${emailSubject}`;
  }
  
  return emailSubject;
}
```

### 3. セグメントと起因に基づく変換

```typescript
function generateAlertSubject(
  emailSubject: string,
  segment: string,
  cause: '顧客起因' | '自社営業起因',
  aiSummary: string
): string {
  const segmentLabels: Record<string, string> = {
    'forecast_tone_down': 'トーンダウン',
    'forecast_trust_risk': '不安・不信感',
    'forecast_inactive': '放置予兆',
    'occurrence_followup': '催促',
    'occurrence_complaint': '不満',
    // ... 他のセグメント
  };
  
  const segmentLabel = segmentLabels[segment] || segment;
  const causeLabel = cause === '自社営業起因' ? '[自社起因]' : '';
  
  // メール件名を簡潔に
  const shortSubject = emailSubject
    .replace(/^(Re:|RE:|Fw:|FW:)\s*/i, '')
    .substring(0, 30);
  
  return `${causeLabel}${segmentLabel}: ${shortSubject}`;
}
```

## 実装例

`app/api/alerts/route.ts`に変換関数を追加：

```typescript
function transformEmailSubjectToAlertSubject(
  emailSubject: string,
  segment?: string,
  aiSummary?: string
): string {
  if (!emailSubject) return '件名なし';
  
  // 基本的なクリーニング
  let cleaned = emailSubject
    .replace(/^(Re:|RE:|Fw:|FW:|Fwd:|FWD:)\s*/i, '')
    .trim();
  
  // セグメントに応じた変換
  if (segment) {
    const segmentLabels: Record<string, string> = {
      'forecast_tone_down': 'トーンダウン',
      'forecast_trust_risk': '不安・不信感',
      'forecast_inactive': '放置予兆',
      'occurrence_followup': '催促',
      'occurrence_complaint': '不満',
      'occurrence_silence': '沈黙',
      'occurrence_proposal_issue': '提案ミス',
      'occurrence_info_gap': '情報共有ミス',
      'occurrence_delay': '遅延',
      'occurrence_reoccurrence': '再発',
      'follow_recovery': '回復確認',
    };
    
    const segmentLabel = segmentLabels[segment];
    if (segmentLabel) {
      return `${segmentLabel}: ${cleaned.substring(0, 40)}`;
    }
  }
  
  return cleaned;
}

// 使用例（390行目あたり）
const alerts = rows.map((row: any) => {
  // ...
  return {
    // ...
    subject: transformEmailSubjectToAlertSubject(
      row.subject || '',
      row.new_primary_segment,
      row.body_preview
    ),
    email_subject: row.subject || '', // 元のメール件名を保持
    // ...
  };
});
```

## 推奨事項

1. **メール件名をそのまま使用する場合**
   - シンプルで実装が簡単
   - ユーザーが元のメール件名をそのまま確認できる

2. **変換ロジックを実装する場合**
   - アラート件名をより分かりやすくできる
   - セグメント情報を件名に含められる
   - ただし、元のメール件名も`email_subject`として保持することを推奨

3. **ハイブリッドアプローチ**
   - デフォルトはメール件名をそのまま使用
   - セグメントやAI要約に基づいて、必要に応じて変換
   - ユーザー設定で変換の有無を切り替え可能にする


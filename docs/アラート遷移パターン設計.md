# アラート遷移パターン設計

## 概要

アラートは以下の3つのフェーズを横軸で移動します：
- **予兆（forecast）**: リスクの兆候を検知
- **発生（occurrence）**: 実際の問題が発生
- **回復（follow）**: 対応後の回復状況を確認

## フェーズ定義

### 1. 予兆（forecast）

**セグメント**:
- `forecast_tone_down`: トーンダウン
- `forecast_interest_drop`: 関心低下
- `forecast_trust_risk`: 不安・不信感
- `forecast_inactive`: 放置予兆
- `forecast_response_quality`: 対応時間/品質

**特徴**:
- まだ問題は発生していないが、リスクの兆候がある状態
- 早期対応により問題発生を防ぐことが可能
- 検知ルールや感情分析で検出

**表示すべき指標**:
- ✅ 検知ルール（検知データがある場合）
- ✅ 品質スコア（Phase D）
- ❌ 鎮火確率（まだ発生していないため測定不可）

### 2. 発生（occurrence）

**セグメント**:
- `occurrence_followup`: 催促
- `occurrence_complaint`: 不満
- `occurrence_silence`: 沈黙
- `occurrence_proposal_issue`: 提案ミス
- `occurrence_info_gap`: 情報共有ミス
- `occurrence_delay`: 遅延
- `occurrence_reoccurrence`: 再発

**特徴**:
- 実際に問題が発生している状態
- 顧客からの明確な不満や催促がある
- 緊急度が高い

**表示すべき指標**:
- ✅ 検知ルール（検知データがある場合）
- ✅ 品質スコア（Phase D）
- ❌ 鎮火確率（まだ対応していないため測定不可）

### 3. 回復（follow）

**セグメント**:
- `follow_recovery`: 回復確認

**特徴**:
- 事象発生から対応を行った後の状態
- 鎮火できたかどうかを確認する段階
- 顧客の温度感や満足度を測定

**表示すべき指標**:
- ✅ 検知ルール（検知データがある場合）
- ✅ 品質スコア（Phase D）
- ✅ 鎮火確率（Phase C）- **このフェーズでのみ表示**

## 遷移パターン

### パターン1: 予兆 → 発生 → 回復

```
forecast_* → occurrence_* → follow_recovery
```

**遷移条件**:
- **予兆 → 発生**: 
  - 検知スコアが閾値を超える（例: 70以上）
  - 顧客から明確な不満や催促が検出される
  - 感情スコアが大きく低下（例: -0.5以下）
  - 検知ルールが発動（例: `sentiment_urgency`, `inactivity_72h`）

- **発生 → 回復**:
  - 対応が実施された（ステータスが `in_progress` または `completed`）
  - 一定時間経過後（例: 24時間以上）
  - 顧客からの反応がポジティブに変化
  - 鎮火確率の計算が可能になった時点

### パターン2: 予兆 → 回復（発生をスキップ）

```
forecast_* → follow_recovery
```

**遷移条件**:
- 予兆段階で早期対応が成功し、問題発生を回避
- 顧客の温度感が回復したことを確認

### パターン3: 発生 → 回復（予兆をスキップ）

```
occurrence_* → follow_recovery
```

**遷移条件**:
- 予兆を検知できず、いきなり問題が発生
- 緊急度が高く、即座に対応が必要

## 遷移判定ロジック

### 予兆 → 発生の判定

```typescript
function shouldTransitionToOccurrence(alert: Alert): boolean {
  // 1. 検知スコアが閾値を超える
  if (alert.detection_score >= 70) return true;
  
  // 2. 緊急度スコアが高い
  if (alert.urgencyScore >= 70) return true;
  
  // 3. 感情スコアが大きく低下
  if (alert.sentiment_score <= -0.5) return true;
  
  // 4. 検知ルールが発動
  if (alert.detectionRule?.rule_type === 'sentiment_urgency') return true;
  if (alert.detectionRule?.rule_type === 'inactivity_72h' && 
      alert.detectionRule.hours_since_last_activity >= 72) return true;
  
  // 5. セグメントが発生系に該当
  const segmentMeta = getSegmentMeta(alert.primarySegment);
  if (segmentMeta?.category.key === 'occurrence') return true;
  
  return false;
}
```

### 発生 → 回復の判定

```typescript
function shouldTransitionToRecovery(alert: Alert): boolean {
  // 1. 対応が実施されている
  if (alert.status === 'in_progress' || alert.status === 'completed') {
    // 2. 対応開始から一定時間経過（例: 24時間以上）
    const updatedAt = new Date(alert.updated_at).getTime();
    const now = Date.now();
    const hoursSinceUpdate = (now - updatedAt) / (1000 * 60 * 60);
    
    if (hoursSinceUpdate >= 24) {
      // 3. 鎮火確率の計算が可能（Phase Cデータがある）
      if (alert.phaseC) return true;
      
      // 4. 顧客の反応がポジティブに変化
      if (alert.sentiment_score > 0) return true;
    }
  }
  
  return false;
}
```

## 実装方針

### 1. セグメント遷移の管理

- アラートの `primarySegment` を更新するバッチ処理を実装
- 遷移履歴を `alert_segment_history` テーブルに記録
- 遷移タイミングを `updated_at` で追跡

### 2. 指標表示の制御

各フェーズで表示すべき指標を制御：

```typescript
function getDisplayableMetrics(alert: Alert) {
  const segmentMeta = getSegmentMeta(alert.primarySegment);
  const category = segmentMeta?.category.key;
  
  return {
    detection: alert.detectionRule ? true : false,
    quality: alert.phaseD ? true : false,
    resolution: category === 'follow' && alert.phaseC ? true : false, // 回復期のみ
  };
}
```

### 3. UI表示の統一

- カード表示: フェーズに応じた指標のみ表示
- モーダル表示: フェーズ情報と遷移履歴を表示
- ダッシュボード: フェーズ別の集計と遷移率を可視化

## データモデル拡張案

### alert_segment_history テーブル

```sql
CREATE TABLE alert_segment_history (
  id STRING,
  alert_id STRING,
  from_segment STRING,
  to_segment STRING,
  transition_reason STRING,
  transition_score FLOAT64,
  created_at TIMESTAMP
);
```

### Alert型の拡張

```typescript
interface Alert {
  // ... 既存フィールド
  segmentHistory?: Array<{
    from: SegmentKey;
    to: SegmentKey;
    reason: string;
    timestamp: string;
  }>;
  currentPhase: 'forecast' | 'occurrence' | 'follow';
  phaseTransitionedAt?: string;
}
```

## 次のステップ

1. ✅ 鎮火確率の表示条件を回復期に変更（完了）
2. ⏳ 遷移判定ロジックの実装
3. ⏳ 遷移履歴の記録機能
4. ⏳ UIでの遷移可視化
5. ⏳ バッチ処理での自動遷移



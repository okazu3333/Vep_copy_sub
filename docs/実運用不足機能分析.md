# 実運用不足機能分析

## 概要

実メールでの検知運用を開始する前に、不足している分析モデルとステータス管理機能を整理しました。

## 現在実装済みの機能

### ✅ 検知ルール（6種類）
- `inactivity_72h`: 72時間放置検知
- `night_reply_rate`: 夜間返信率異常検知
- `sentiment_urgency`: 感情ダウン + 催促ワード
- `tone_frequency_drop`: トーン + 頻度低下
- `recovery_monitoring`: 沈静化監視（新規）
- `topic_repetition_tone_drop`: 同一トピック繰り返し（新規）

### ✅ 分析モデル
- **Phase C**: 鎮火確率・TTR予測
- **Phase D**: 返信品質スコア・類似事例検索

### ✅ セグメント分類
- 予兆（forecast）: 5種類
- 発生（occurrence）: 7種類
- 回復（follow）: 1種類

### ✅ 基本ステータス
- `unhandled`: 未対応
- `in_progress`: 対応中
- `completed`: 解決済み

---

## 実運用で不足しそうな機能

### 🔴 高優先度（実運用開始前に実装推奨）

#### 1. **自動ステータス遷移・自動解決判定**
**現状**: 手動でステータス更新が必要
**不足**:
- 顧客からのポジティブな反応で自動的に`completed`に遷移
- 一定期間（例: 7日間）反応がない場合の自動アーカイブ
- 誤検知の自動判定（例: スパム、自動返信など）

**実装要件**:
```typescript
interface AutoResolutionRule {
  condition: 'positive_sentiment' | 'no_response_7d' | 'spam_detected';
  threshold: number;
  action: 'complete' | 'archive' | 'dismiss';
}
```

#### 2. **セグメント間の自動遷移判定**
**現状**: 設計はあるが実装されていない
**不足**:
- 予兆 → 発生の自動判定
- 発生 → 回復の自動判定
- 遷移履歴の記録

**実装要件**:
- `alert_segment_history`テーブルの作成
- バッチ処理での自動遷移判定
- 遷移理由の記録

#### 3. **エスカレーション判定**
**現状**: 優先度（A/B/C）はあるが、自動エスカレーションがない
**不足**:
- 対応が遅延している場合の自動エスカレーション
- 担当者の負荷が高い場合の自動再割り当て
- 上層部への自動通知

**実装要件**:
```typescript
interface EscalationRule {
  trigger: 'sla_breach' | 'no_response_24h' | 'sentiment_critical';
  target: 'manager' | 'executive' | 'team';
  notification: 'email' | 'slack' | 'system';
}
```

#### 4. **アラートの重複検知・統合**
**現状**: 同じスレッド内の重複はある程度処理されているが、不完全
**不足**:
- 異なるスレッド間での類似アラート検知
- 自動統合機能
- 統合履歴の記録

**実装要件**:
- 類似度計算（embeddingベース）
- 統合ルールの定義
- 統合後のアラート管理

---

### 🟡 中優先度（運用開始後1-2ヶ月以内に実装推奨）

#### 5. **優先度の自動調整**
**現状**: 手動設定のみ
**不足**:
- 検知スコアに基づく自動優先度調整
- 時間経過による優先度の自動上昇
- 顧客重要度を考慮した優先度計算

**実装要件**:
```typescript
function calculateAutoPriority(alert: Alert): 'A' | 'B' | 'C' {
  const baseScore = alert.detection_score || 0;
  const sentimentWeight = alert.sentiment_score < -0.5 ? 20 : 0;
  const customerWeight = alert.customerTier === 'VIP' ? 15 : 0;
  const timeWeight = calculateTimeWeight(alert.updated_at);
  
  const totalScore = baseScore + sentimentWeight + customerWeight + timeWeight;
  
  if (totalScore >= 80) return 'A';
  if (totalScore >= 50) return 'B';
  return 'C';
}
```

#### 6. **担当者負荷の可視化・最適化**
**現状**: 担当者別の集計はあるが、負荷分析がない
**不足**:
- 担当者別の未対応件数・平均対応時間
- 負荷バランスの可視化
- 自動再割り当ての提案

**実装要件**:
- `vw_person_workload`ビューの作成
- 負荷スコアの計算
- 再割り当て推奨ロジック

#### 7. **顧客重要度（VIP判定）**
**現状**: 顧客情報はあるが、重要度の自動判定がない
**不足**:
- 契約金額・契約期間に基づく重要度判定
- 過去のアラート頻度によるリスク判定
- 重要度に基づく優先度調整

**実装要件**:
```typescript
interface CustomerTier {
  tier: 'VIP' | 'Premium' | 'Standard' | 'Trial';
  contractValue: number;
  contractDuration: number;
  alertFrequency: number;
  riskScore: number;
}
```

#### 8. **誤検知のフィードバックループ**
**現状**: 誤検知を手動で除外する機能がない
**不足**:
- 誤検知の報告機能
- 誤検知パターンの学習
- 検知ルールの自動調整

**実装要件**:
- 誤検知報告API
- 誤検知パターンの記録
- 検知ルールの閾値自動調整

---

### 🟢 低優先度（運用開始後3-6ヶ月以内に実装推奨）

#### 9. **対応履歴の分析・学習**
**現状**: 対応履歴は記録されているが、分析機能がない
**不足**:
- 成功した対応パターンの抽出
- 失敗した対応パターンの分析
- 対応品質の時系列トレンド

**実装要件**:
- 対応履歴分析ビュー
- 成功パターンの可視化
- 改善提案の自動生成

#### 10. **営業機会の検知**
**現状**: ネガティブなシグナルのみ検知
**不足**:
- ポジティブなシグナルの検知（例: 拡張要望、追加提案への関心）
- 営業機会の自動アラート
- 機会スコアの計算

**実装要件**:
```typescript
interface OpportunitySignal {
  type: 'expansion' | 'upsell' | 'referral' | 'renewal';
  confidence: number;
  keywords: string[];
  sentiment: 'positive';
}
```

#### 11. **契約更新リスクの早期検知**
**現状**: 契約更新に関する検知がない
**不足**:
- 契約更新時期の検知
- 更新リスクの予測
- 更新促進アクションの提案

**実装要件**:
- 契約情報との連携
- 更新リスクスコアの計算
- 更新促進タスクの自動生成

#### 12. **顧客満足度の追跡**
**現状**: 感情スコアはあるが、満足度の追跡がない
**不足**:
- 対応後の満足度スコア
- 満足度の時系列トレンド
- 満足度に基づくリスク判定

**実装要件**:
- 満足度スコアの計算（感情スコア + 対応品質）
- 満足度トレンドの可視化
- 低満足度顧客の自動アラート

#### 13. **類似ケースの自動検索・提案**
**現状**: APIはあるが、自動化されていない
**不足**:
- アラート検知時の自動類似ケース検索
- 成功事例の自動提案
- 過去の対応履歴からの学習

**実装要件**:
- アラート検知時の自動トリガー
- 類似ケースの自動表示
- 成功事例のハイライト

---

## ステータス管理の拡張案

### 現在のステータス
```typescript
status: 'unhandled' | 'in_progress' | 'completed'
```

### 拡張案
```typescript
status: 
  | 'unhandled'        // 未対応
  | 'acknowledged'     // 確認済み（新規）
  | 'in_progress'      // 対応中
  | 'waiting_customer' // 顧客待ち（新規）
  | 'escalated'        // エスカレーション中（新規）
  | 'resolved'         // 解決済み（completedから変更）
  | 'closed'           // クローズ済み（新規）
  | 'dismissed'        // 却下（誤検知など）（新規）
```

### ステータス遷移フロー
```
unhandled → acknowledged → in_progress → waiting_customer → resolved → closed
                ↓                              ↓
            escalated                      escalated
                ↓                              ↓
            resolved                        resolved
```

---

## 実装優先順位

### Phase 1（実運用開始前）
1. ✅ 自動ステータス遷移・自動解決判定
2. ✅ セグメント間の自動遷移判定
3. ✅ エスカレーション判定
4. ✅ アラートの重複検知・統合

### Phase 2（運用開始後1-2ヶ月）
5. ✅ 優先度の自動調整
6. ✅ 担当者負荷の可視化・最適化
7. ✅ 顧客重要度（VIP判定）
8. ✅ 誤検知のフィードバックループ

### Phase 3（運用開始後3-6ヶ月）
9. ✅ 対応履歴の分析・学習
10. ✅ 営業機会の検知
11. ✅ 契約更新リスクの早期検知
12. ✅ 顧客満足度の追跡
13. ✅ 類似ケースの自動検索・提案

---

## データモデル拡張案

### alert_status_history テーブル
```sql
CREATE TABLE alert_status_history (
  id STRING,
  alert_id STRING,
  from_status STRING,
  to_status STRING,
  transition_reason STRING,
  transitioned_by STRING,
  transitioned_at TIMESTAMP
);
```

### alert_escalations テーブル
```sql
CREATE TABLE alert_escalations (
  id STRING,
  alert_id STRING,
  escalation_reason STRING,
  escalated_to STRING,
  escalated_at TIMESTAMP,
  resolved_at TIMESTAMP
);
```

### customer_tiers テーブル
```sql
CREATE TABLE customer_tiers (
  customer_id STRING,
  tier STRING, -- VIP, Premium, Standard, Trial
  contract_value FLOAT64,
  contract_start_date DATE,
  contract_end_date DATE,
  risk_score FLOAT64,
  updated_at TIMESTAMP
);
```

---

## 次のアクション

1. **Phase 1の実装計画を立てる**
2. **データモデルの拡張を設計**
3. **バッチ処理のスケジュールを決定**
4. **UIでの新機能表示を設計**



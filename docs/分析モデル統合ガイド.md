# 分析モデル統合ガイド

## 概要

既存のアラート検知システムを新しい分析モデル（検知ルール、フェーズC、フェーズD）に統合しました。

## 実装内容

### 1. 統合アラート検知API

**エンドポイント:** `/api/alerts-detection`

新しい分析モデル（検知ルール、フェーズC、フェーズD）の結果を統合してアラートを生成します。

**使用方法:**
```bash
GET /api/alerts-detection?limit=100&severity=A&segment=inactivity_risk
```

**パラメータ:**
- `limit`: 取得件数（デフォルト: 100）
- `severity`: 重要度フィルタ（A/B/C）
- `segment`: セグメントフィルタ
- `include_detection_rules`: 検知ルールを含める（デフォルト: true）
- `include_phase_c`: フェーズCを含める（デフォルト: true）
- `include_phase_d`: フェーズDを含める（デフォルト: true）

### 2. 既存アラートAPIの拡張

**エンドポイント:** `/api/alerts`

既存のアラートAPIに新しい分析モデルの結果を統合しました。

**追加された機能:**
- フェーズCの予測結果（`p_resolved_24h`, `ttr_pred_min`）を統合
- フェーズDの品質スコア（`quality_score`, `quality_level`）を統合
- 検知ルールの結果（`detection_rule_type`, `hours_since_last_activity`）を統合
- 統合スコア計算（既存スコア + 新しい指標の加重平均）

**レスポンス例:**
```json
{
  "id": "...",
  "threadId": "...",
  "phaseC": {
    "p_resolved_24h": 0.25,
    "ttr_pred_min": 1440,
    "hazard_score": 0.8
  },
  "phaseD": {
    "quality_score": 45,
    "quality_level": "Low"
  },
  "detectionRule": {
    "rule_type": "inactivity_72h",
    "hours_since_last_activity": 96,
    "score": 70
  },
  "detectionReasons": [
    "72時間放置",
    "鎮火確率が低い (25%)",
    "返信品質が低い (45点)"
  ]
}
```

### 3. 検知ルールバッチ処理

**スクリプト:** `scripts/sync_detection_alerts.ts`

検知ルール結果をBigQueryの`detection_alerts`テーブルに保存します。

**実行方法:**
```bash
npx tsx scripts/sync_detection_alerts.ts
```

**スケジュール実行:**
- 日次実行（Cloud Run Job / Composer）
- 実行時刻: 毎日 6:00 JST

### 4. アラート詳細画面の拡張

**ファイル:** `components/alerts/AlertDetail.tsx`

新しい分析モデルの指標を表示するように拡張しました。

**表示内容:**
- フェーズC: 鎮火確率（24時間以内）、予測解決時間
- フェーズD: 返信品質スコア、品質レベル
- 検知ルール: ルールタイプ、放置時間、検知スコア

## 検知ルール一覧

### 1. 72時間放置検知 (`inactivity_72h`)
- **条件:** 最終アクティビティから72時間以上経過
- **スコア:** 放置時間が長いほど高い（最大100）
- **重要度:** 
  - A: 168時間以上（7日）
  - B: 120時間以上（5日）
  - C: 72時間以上（3日）

### 2. 感情ダウン + 催促ワード検知 (`sentiment_urgency`)
- **条件:** 
  - 感情スコア < -0.3
  - 催促ワードを含む（「進捗いかが」「お返事いただけますでしょうか」など）
- **スコア:** 感情スコアと催促ワード数に基づく
- **重要度:**
  - A: 感情スコア < -0.6 かつ 催促ワード >= 2
  - B: 感情スコア < -0.3 かつ 催促ワード >= 1
  - C: その他

### 3. トーンダウン + 返信頻度変化検知 (`tone_frequency_drop`)
- **条件:**
  - 過去30日と過去7日で感情スコアが0.2以上下降
  - かつ返信頻度が50%以下に低下
- **スコア:** 感情下降と頻度下降の両方に基づく
- **重要度:**
  - A: 感情下降 < -0.4 かつ 頻度比 < 0.3
  - B: 感情下降 < -0.2 かつ 頻度比 < 0.5
  - C: その他

### 4. 夜間返信率異常検知 (`night_reply_rate`)
- **条件:**
  - 担当者の夜間返信率（22:00-6:00）が50%超
  - ベースラインから20%以上上昇
- **スコア:** 夜間返信率とベースラインからの差に基づく
- **重要度:** スコアに基づき自動判定

## 統合スコア計算

新しい統合スコアは以下の式で計算されます：

```
統合スコア = 既存スコア 
  + (1.0 - p_resolved_24h) * 20  // 低鎮火確率を加算
  + (100 - quality_score) * 0.1  // 低品質を加算
  + detection_rule_score * 0.3   // 検知ルールスコアを加算
```

## データフロー

```
1. 検知ルール実行
   ↓
2. detection_alerts テーブルに保存（バッチ処理）
   ↓
3. /api/alerts で統合（リアルタイム）
   ↓
4. アラート詳細画面に表示
```

## 運用フロー

### 日次バッチ
1. **検知ルール実行** (`sync_detection_alerts.ts`)
   - 実行時刻: 毎日 6:00 JST
   - 結果を `detection_alerts` テーブルに保存

2. **フェーズC学習・推論** (`train_incident_outcomes.py`)
   - 実行頻度: 週次
   - 結果を `incident_outcomes` テーブルに保存

3. **フェーズD品質スコアリング** (`score_reply_quality.py`)
   - 実行頻度: 週次
   - 結果を `reply_quality` テーブルに保存

### リアルタイムAPI
- `/api/alerts`: 既存アラート + 新しい指標を統合
- `/api/alerts-detection`: 新しい検知ルール専用API
- `/api/detection-rules`: 検知ルール詳細取得

## 移行チェックリスト

- [x] 統合アラート検知APIの作成
- [x] 既存アラートAPIの拡張
- [x] 検知ルールバッチ処理の実装
- [x] アラート詳細画面の拡張
- [ ] BigQueryビューの作成・確認
- [ ] バッチ処理のスケジュール設定
- [ ] 動作確認・テスト
- [ ] 本番環境へのデプロイ

## トラブルシューティング

### 検知ルールが表示されない
1. `detection_alerts` テーブルが存在するか確認
2. `sync_detection_alerts.ts` が正常に実行されているか確認
3. BigQueryの権限を確認

### フェーズC/Dの結果が表示されない
1. `incident_outcomes` / `reply_quality` テーブルにデータがあるか確認
2. 学習・推論スクリプトが正常に実行されているか確認
3. テーブルのパーティション設定を確認

### 統合スコアが正しく計算されない
1. 各テーブルのデータ型を確認
2. SQLクエリのJOIN条件を確認
3. スコア計算式の重みを調整

## 参考資料

- [分析モデル実装状況](./分析モデル実装状況.md)
- [フェーズCモデリング計画](./フェーズCモデリング計画.md)
- [フェーズD品質スコア計画](./フェーズD品質スコア計画.md)


# セグメント遷移・自動解決実装ガイド

## 概要

アラートのセグメント間の自動遷移判定と、ポジティブ反応による自動completed化機能を実装しました。

## 実装内容

### 1. セグメント間の自動遷移判定

#### 予兆 → 発生の自動遷移
**判定条件**（いずれかが該当）:
- 検知スコア >= 70
- 緊急度スコア >= 70
- 感情スコア <= -0.5
- 検知ルール: `sentiment_urgency`
- 検知ルール: `inactivity_72h` かつ 72時間以上未対応

**遷移先**: `occurrence_followup`（デフォルト）

#### 発生 → 回復の自動遷移
**判定条件**（すべて該当）:
- ステータスが `in_progress` または `completed`
- 対応開始から24時間以上経過
- 以下のいずれか:
  - Phase Cデータ（鎮火確率）が存在
  - 感情スコア > 0（ポジティブ反応）

**遷移先**: `follow_recovery`

### 2. ポジティブ反応による自動completed化

**判定条件**（いずれかが該当）:
- 7日間の平均感情スコア > 0.3 かつ メッセージ数 >= 2件
- 現在の感情スコア > 0.5

**アクション**: ステータスを `completed` に自動更新

## データベース構造

### テーブル

#### `alert_segment_history`
セグメント遷移履歴を記録

```sql
CREATE TABLE alert_segment_history (
  id STRING,
  alert_id STRING,
  thread_id STRING,
  from_segment STRING,
  to_segment STRING,
  transition_reason STRING,
  transition_score FLOAT64,
  transitioned_by STRING, -- 'system' | 'manual' | user_id
  created_at TIMESTAMP
)
```

#### `alert_auto_resolutions`
自動解決履歴を記録

```sql
CREATE TABLE alert_auto_resolutions (
  id STRING,
  alert_id STRING,
  thread_id STRING,
  resolution_type STRING, -- 'positive_sentiment' | 'no_response_7d' | 'spam_detected'
  resolution_score FLOAT64,
  resolution_reason STRING,
  previous_status STRING,
  resolved_at TIMESTAMP
)
```

### ビュー

#### `vw_alert_transition_candidates`
遷移候補を判定するビュー

#### `vw_auto_resolution_candidates`
自動解決候補を判定するビュー

## 実装ファイル

### SQL定義
- `/scripts/sql/bq_alert_transitions.sql` - テーブル・ビュー定義

### バッチ処理
- `/scripts/process_alert_transitions.ts` - 遷移・自動解決のバッチ処理

### API
- `/app/api/alert-transitions/route.ts` - 遷移履歴取得・手動遷移実行API

### 型定義
- `/types/index.ts` - `SegmentTransition`, `AutoResolution` インターフェース

## セットアップ手順

### 1. BigQueryテーブル・ビューの作成

```bash
bq query --use_legacy_sql=false < scripts/sql/bq_alert_transitions.sql
```

### 2. バッチ処理の実行

#### 手動実行
```bash
npx ts-node scripts/process_alert_transitions.ts
```

#### 定期実行（cron等）
```bash
# 1時間ごとに実行
0 * * * * cd /path/to/project && npx ts-node scripts/process_alert_transitions.ts
```

## API使用方法

### 遷移履歴の取得

```bash
# 特定のスレッドの遷移履歴
GET /api/alert-transitions?thread_id=thread-001&limit=10

# 特定のアラートの遷移履歴
GET /api/alert-transitions?alert_id=alert-001&limit=10
```

**レスポンス例**:
```json
{
  "success": true,
  "transitions": [
    {
      "id": "transition_1234567890_0",
      "alert_id": "alert-001",
      "thread_id": "thread-001",
      "from_segment": "forecast_tone_down",
      "to_segment": "occurrence_followup",
      "transition_reason": "検知スコア高感情スコア低下",
      "transition_score": 85.5,
      "transitioned_by": "system",
      "created_at": "2025-01-15T10:30:00Z"
    }
  ],
  "auto_resolutions": [
    {
      "id": "resolution_1234567890_0",
      "alert_id": "alert-002",
      "thread_id": "thread-002",
      "resolution_type": "positive_sentiment",
      "resolution_score": 75.0,
      "resolution_reason": "7日間の平均感情スコア: 0.35 (3件)",
      "previous_status": "in_progress",
      "resolved_at": "2025-01-15T11:00:00Z"
    }
  ]
}
```

### 手動での遷移実行

```bash
POST /api/alert-transitions
Content-Type: application/json

{
  "thread_id": "thread-001",
  "alert_id": "alert-001",
  "from_segment": "forecast_tone_down",
  "to_segment": "occurrence_followup",
  "transition_reason": "手動で発生セグメントに遷移",
  "transitioned_by": "user-123"
}
```

## バッチ処理のロジック

### セグメント遷移処理

1. `vw_alert_transition_candidates`ビューから遷移候補を取得
2. 遷移履歴を`alert_segment_history`テーブルに記録
3. `alerts_v2_scored`テーブルの`primary_segment`を更新

### 自動解決処理

1. `vw_auto_resolution_candidates`ビューから自動解決候補を取得
2. 自動解決履歴を`alert_auto_resolutions`テーブルに記録
3. `alerts_v2_scored`テーブルの`status`を`completed`に更新

## 判定ロジックの詳細

### 予兆 → 発生の遷移スコア計算

```typescript
transition_score = 
  detection_score (0-100) +
  urgency_score * 0.3 +
  (sentiment_score <= -0.5 ? 20 : 0) +
  (detection_rule_type === 'sentiment_urgency' ? 15 : 0) +
  (detection_rule_type === 'inactivity_72h' && hours >= 72 ? 10 : 0)
```

### 発生 → 回復の遷移スコア計算

```typescript
transition_score = 
  status === 'completed' ? 100 :
  status === 'in_progress' && phaseC存在 ? 80 :
  status === 'in_progress' && sentiment_score > 0 ? 70 :
  status === 'in_progress' && 24h経過 ? 60 :
  0
```

### 自動解決の判定

```typescript
// ポジティブ反応による自動解決
if (avg_sentiment_7d > 0.3 && message_count_7d >= 2) {
  resolution_type = 'positive_sentiment';
  resolution_score = avg_sentiment_7d * 100;
}
else if (sentiment_score > 0.5) {
  resolution_type = 'positive_sentiment';
  resolution_score = sentiment_score * 100;
}
```

## 注意事項

1. **バッチ処理の実行頻度**: 1時間ごとの実行を推奨（過度な実行は負荷が高い）
2. **遷移の重複防止**: 同じ遷移は1回のみ実行される（履歴テーブルで確認）
3. **手動遷移の優先**: 手動で遷移した場合は、自動遷移は実行されない
4. **ステータス更新の整合性**: 自動解決は`unhandled`または`in_progress`のアラートのみ対象

## トラブルシューティング

### 遷移が実行されない場合

1. `vw_alert_transition_candidates`ビューにデータが存在するか確認
2. アラートの`primary_segment`が正しく設定されているか確認
3. 判定条件の閾値が適切か確認

### 自動解決が実行されない場合

1. `vw_auto_resolution_candidates`ビューにデータが存在するか確認
2. 感情スコアが正しく計算されているか確認
3. メッセージの`direction`が`inbound`になっているか確認

## 今後の拡張案

1. **遷移の通知機能**: 遷移発生時にSlack/Email通知
2. **遷移の可視化**: UIでの遷移履歴タイムライン表示
3. **遷移ルールのカスタマイズ**: 管理者が判定条件を調整可能に
4. **誤検知の学習**: 手動で却下された遷移を学習して精度向上



# 検知モデル整備計画

## 現状分析

### 検知ルールがあるセグメント（3/10）

| セグメント | 検知ルール | 状態 |
|-----------|-----------|------|
| `forecast_tone_down` | `tone_frequency_drop` | ✅ 実装済み |
| `forecast_inactive` | `inactivity_72h` | ✅ 実装済み |
| `occurrence_followup` | `sentiment_urgency` | ✅ 実装済み |

### 検知ルールがないセグメント（7/10）

| セグメント | 説明 | 必要な検知ルール |
|-----------|------|----------------|
| `forecast_trust_risk` | ROIや進め方の不安が顕在化 | `forecast_trust_risk_detection` |
| `forecast_response_quality` | 夜間対応や回答品質のばらつき | `forecast_response_quality_detection` |
| `occurrence_complaint` | 機能・価格・対応への不満 | `occurrence_complaint_detection` |
| `occurrence_silence` | こちらからの連絡に対して返答が止まっている | `occurrence_silence_detection` |
| `occurrence_proposal_issue` | 提案内容が意図を外し、修正依頼が入っている | `occurrence_proposal_issue_detection` |
| `occurrence_reoccurrence` | 過去に解決したはずの課題が再発 | `occurrence_reoccurrence_detection` |
| `follow_recovery` | 施策後の改善状況を確認 | `follow_recovery_detection` |

### セグメント未割り当ての検知ルール（3件）

| 検知ルール | 説明 | 推奨セグメント |
|-----------|------|--------------|
| `tone_down_inquiry` | 感情ダウン + 催促/確認系フレーズ | `forecast_tone_down` または `occurrence_followup` |
| `night_reply_anomaly` | 夜間返信率の異常上昇 | `forecast_response_quality` |
| `tone_and_freq_drop` | トーン低下 + 返信頻度低下 | `forecast_tone_down` |

## 必要な検知モデルの設計

### 1. `forecast_trust_risk_detection`

**検知条件:**
- キーワード: ROI、不安、懸念、確認、比較、競合、他社
- 感情: ネガティブまたは中立
- 文脈: 意思決定への不安、進め方への懸念
- タイミング: 提案後、契約前

**実装方針:**
```sql
CREATE OR REPLACE VIEW `viewpers.salesguard_alerts.det_rule_trust_risk` AS
-- ROIや進め方への不安を検知
-- キーワード: ROI、不安、懸念、確認、比較、競合
-- 感情スコア: < -0.2
-- セグメント: forecast_trust_risk
```

### 2. `forecast_response_quality_detection`

**検知条件:**
- 既存ルール: `night_reply_anomaly` を活用
- 追加条件: 返信頻度低下、回答品質のばらつき
- タイミング: 継続的な監視

**実装方針:**
```sql
-- night_reply_anomaly を forecast_response_quality に割り当て
-- 追加で返信頻度低下を検知
```

### 3. `occurrence_complaint_detection`

**検知条件:**
- キーワード: クレーム、不満、問題、トラブル、不具合、エラー
- 感情: ネガティブ（sentiment_score < -0.4）
- 文脈: 機能・価格・対応への不満
- タイミング: 顧客からの返信

**実装方針:**
```sql
CREATE OR REPLACE VIEW `viewpers.salesguard_alerts.det_rule_complaint` AS
-- クレーム・不満を検知
-- キーワード: クレーム、不満、問題、トラブル、不具合、エラー
-- 感情スコア: < -0.4
-- セグメント: occurrence_complaint
```

### 4. `occurrence_silence_detection`

**検知条件:**
- 自社営業側からの連絡（outbound）後、一定期間（例: 48時間）顧客からの返信がない
- 再送要請の記録
- タイミング: 自社営業側からの連絡後

**実装方針:**
```sql
CREATE OR REPLACE VIEW `viewpers.salesguard_alerts.det_rule_silence` AS
-- 返信未着を検知
-- 条件: 自社営業側からの連絡後、48時間以上顧客からの返信がない
-- セグメント: occurrence_silence
```

### 5. `occurrence_proposal_issue_detection`

**検知条件:**
- キーワード: 修正、変更、違う、期待、要望、確認不足、資料、再共有
- 文脈: 提案内容への指摘、期待値とのズレ、情報不足の指摘
- 感情: ネガティブまたは中立
- タイミング: 提案送付後（outbound）の顧客返信（inbound）

**実装方針:**
```sql
CREATE OR REPLACE VIEW `viewpers.salesguard_alerts.det_rule_proposal_issue` AS
-- 提案差異・情報共有不足を検知
-- キーワード: 修正、変更、違う、期待、要望、確認不足、資料、再共有
-- 文脈: 提案内容への指摘、期待値とのズレ
-- セグメント: occurrence_proposal_issue
```

### 6. `occurrence_reoccurrence_detection`

**検知条件:**
- キーワード: また、再度、再発、同じ問題、前回と同じ
- 文脈: 過去に解決したはずの課題が再発
- タイミング: 過去のアラート解決後、同じ問題が再発

**実装方針:**
```sql
CREATE OR REPLACE VIEW `viewpers.salesguard_alerts.det_rule_reoccurrence` AS
-- 再発を検知
-- キーワード: また、再度、再発、同じ問題、前回と同じ
-- 過去のアラート解決履歴と照合
-- セグメント: occurrence_reoccurrence
```

### 7. `follow_recovery_detection`

**検知条件:**
- キーワード: レビュー、確認、同席、フォロー、改善
- 文脈: 施策後の改善状況確認、レビュー依頼
- 感情: ポジティブまたは中立
- タイミング: 発生セグメント対応後

**実装方針:**
```sql
CREATE OR REPLACE VIEW `viewpers.salesguard_alerts.det_rule_recovery` AS
-- 回復確認を検知
-- キーワード: レビュー、確認、同席、フォロー、改善
-- 感情スコア: > 0 または中立
-- セグメント: follow_recovery
```

## 実装優先順位

### Phase 1: 高優先度（発生セグメント）
1. `occurrence_proposal_issue_detection` - 提案差異・情報共有不足
2. `occurrence_complaint_detection` - 不満
3. `occurrence_silence_detection` - 沈黙

### Phase 2: 中優先度（予兆セグメント）
4. `forecast_trust_risk_detection` - 信頼リスク
5. `forecast_response_quality_detection` - 対応品質（既存ルール活用）

### Phase 3: 低優先度（フォローセグメント）
6. `occurrence_reoccurrence_detection` - 再発
7. `follow_recovery_detection` - 回復確認

## 既存ルールのセグメント割り当て

- `tone_down_inquiry` → `forecast_tone_down` または `occurrence_followup`
- `night_reply_anomaly` → `forecast_response_quality`
- `tone_and_freq_drop` → `forecast_tone_down`

## 実装チェックリスト

- [ ] `forecast_trust_risk_detection` の実装
- [ ] `forecast_response_quality_detection` の実装（既存ルール活用）
- [ ] `occurrence_complaint_detection` の実装
- [ ] `occurrence_silence_detection` の実装
- [ ] `occurrence_proposal_issue_detection` の実装
- [ ] `occurrence_reoccurrence_detection` の実装
- [ ] `follow_recovery_detection` の実装
- [ ] 既存ルールのセグメント割り当て修正
- [ ] 検知ルールとセグメントの対応関係のドキュメント化
- [ ] テストと検証


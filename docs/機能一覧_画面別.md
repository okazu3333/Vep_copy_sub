# 機能一覧（画面別）

本ドキュメントは、現状の画面単位の機能概要を整理したものです。各セクションは Next.js のルーティング（`app/**/page.tsx`）に対応しています。

## 共通レイアウト
- **レイアウト**: `app/layout.tsx`
  - テーマ管理（`ThemeProvider`）、`Sidebar`、`Header`、グローバルトースト（`Toaster`）を提供
  - 全画面に共通の 2 カラムレイアウト（左サイドバー + 右コンテンツ）

- **トップリダイレクト**: `/`（`app/page.tsx`）
  - `/dashboard` へ即時リダイレクト

---

## ダッシュボード: `/dashboard`
- **エグゼクティブ向け KPI 概要（カード）**
  - 総アラート数、対応完了率、リスク予防率、平均解決時間、顧客満足度、収益インパクト
- **エクスポート**
  - PDF 出力（トースト通知のみ）
  - テキスト出力（ファイルダウンロード）
- **タブ切替**
  - 自社目線分析: 時系列チャート、3層アラートチャート（部門・リスクレベル・個人トップ）
  - 顧客状態分析: 高リスク顧客一覧、リスク要因分布、推奨アクション
- **データ取得**
  - `/api/reports?period=...` から集計データ取得（フォールバック値あり）
  - `/api/customer-risk` から顧客リスクデータ取得（フォールバック値あり）

---

## アラート一覧: `/alerts`
- **フィルタ・検索**
  - 重要度（A/B/C）、ステータス（未対応/対応中/解決済み）、フリーテキスト検索
  - クエリパラメータと URL 同期、ページネーション（20件/ページ）
- **AI セグメントサイドバー（件数バッジ付き）**
  - 緊急対応/解約リスク/競合脅威/契約関連/売上機会/その他
- **一覧表示**
  - 件名ハイライト、リスクレベルバッジ、顧客、担当者（API値 or 内部送信者抽出）
  - プライマリセグメントバッジ、リスクスコア表示
- **詳細表示（モーダル）**
  - アラートクリックでスレッドメッセージを `/api/alerts-threaded/messages` から取得し `AlertDetail` を表示
- **データ取得**
  - `/api/alerts`（light=1時はlimit=10000で全ページ取得→フロント側でスコア降順ソート・20件ページネーション）

### アラート詳細: `/alerts/[id]`
- **ヘッダー**
  - 戻る、重要度/ステータスバッジ、基本メタ情報（ID 等）
- **概要（開閉）**
  - 自社情報（対象者・部署・検出キーワード・発生日時）
  - クライアント情報（顧客名・会社名・メール）
- **メッセージ内容**
  - 件名、概要、本文（検出キーワードのハイライト）
- **対応アクション**
  - ステータス変更（未対応/対応中/解決済み）、対応メモ、担当者転送、フォローアップ設定
- **関連情報**
  - スコア、検出レベル、推奨アクション
- **データ取得**
  - `/api/alerts?search={id}&limit=1`

---

## 同意: `/consent`
- **同意項目（全て必須）**
  - データ収集、データ利用、データ共有、リアルタイム監視、レポート・分析
- **同意処理**
  - `localStorage.salesguard_user` に同意フラグ/日時を記録し遷移（管理者は `/dashboard`、従業員は `/employee`）

---

## 顧客管理: `/customers`
- **タブ**
  - 顧客一覧、データインポート（CSV UI）
- **一覧**
  - 検索、顧客テーブル（会社/ドメイン/業界/規模/リスク/メッセージ数/ユーザー数/ステータス）
  - アクション: 担当者情報モーダル、顧客分析ダッシュボードモーダル
  - ページネーション、総件数
- **担当者情報（モーダル）**
  - 担当者プロフィール、連絡先、担当顧客数、対応率、専門分野等
- **顧客分析ダッシュボード（モーダル）**
  - 総合スコア、トレンド、分析メッセージ数、レーダーチャート
  - リスク要因・良好要因、最終分析日時
  - CS 調査結果タブ（履歴、詳細、推奨アクション）
- **CS 調査依頼（モーダル）**
  - テンプレート、期限、送信先情報、送信アクション
- **データ取得**
  - `/api/customers`、`/api/customers/{domain}/assignees`、`/api/customers/{domain}/sentiment`（いずれもフォールバックあり）

---

## 従業員ダッシュボード: `/employee`
- **ヘッダー（ユーザー情報、ログアウト）**
- **ステータスカード**
  - 未対応/対応中/解決済み/高リスク 件数
- **アラート一覧（未対応/対応中）**
  - 顧客、件名、リスクバッジ、優先度、最終連絡、アクション
- **最近の活動（解決済み履歴）**
- **ログイン状態検証**（未ログインは `/login` へ）

---

## ログイン: `/login`
- **ログイン種別タブ（従業員/管理者）**
- **Google ログイン（疑似）/ メール・パスワード**
- **ログイン後処理**
  - `localStorage.salesguard_user` 保存、初回ログインは `/consent` へ、それ以外は権限に応じて遷移
- **デモアカウント表示**

---

## 通知管理: `/notifications`
- **タブ**
  - 通知設定、通知チャンネル、通知ルール
- **通知設定**
  - メール/Slack/SMS の有効化スイッチ
  - 最小アラートレベル、通知間隔、静寂時間
- **チャンネル設定**
  - メール受信者/テンプレート、Slack Webhook/チャンネル、SMS 番号/プロバイダー
  - 各チャンネルでテスト送信
- **通知ルール**
  - 高レベル即時通知、営業部専用通知、週末・夜間制限 等の切替/設定

---

## キーワード管理: `/keywords`
- **セグメント設定（アコーディオン）**
  - 緊急対応/解約リスク/競合脅威/契約関連/売上機会/その他 の各シナリオ編集
  - キーワード、トリガー、通知遅延、重要度の編集
- **キーワードリクエスト**
  - ユースケース入力 → テンプレート生成 → 申請/承認フロー（保留/承認/却下履歴）

### フレーズ設定（AI支援）: `/keywords/segments`
- **AI キーワード生成**（ユースケース入力 → 推奨セグメント/キーワード/理由/信頼度を提示）
- **推奨内容の適用**（承認済みリクエストとして登録）
- **セグメント・シナリオ一覧/詳細、編集、確認ダイアログ**
- **申請・履歴管理**（保留/承認/却下）

---

## ユーザー管理: `/users`
- **概要カード**（総ユーザー数、営業担当者数）
- **フィルター**（検索/権限/ステータス）
- **一覧**
  - 役割・ステータスバッジ、基本情報（メール/会社/部署/電話）
  - 営業ロール向けの追加情報（担当顧客数、今月アラート、対応率、専門分野）
  - 編集/削除アクション（UI）
- **データ取得**
  - `/api/users`（フォールバックでモックを適用）

---

## エラーハンドリング/ローディング
- **エラー画面**
  - `app/error.tsx`（ページ単位）/ `app/global-error.tsx`（グローバル）
  - エラーメッセージ表示、再試行ボタン
- **ローディング**
  - `app/alerts/loading.tsx`、`app/customers/loading.tsx`（現状は `null` を返却）

---

## 備考
- 一部の API はフォールバック（モック）データで動作するよう実装されています。
- 画面内の数値・グラフはデモ用の算出/表示を含みます。
- 実運用時は API 実装やデータスキーマに合わせて差替えが必要です。

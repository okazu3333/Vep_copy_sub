# 分析モデル実装状況

## 実装完了項目

### ✅ フェーズC: インシデント結果予測（鎮火確率・TTR予測）

**実装ファイル:**
- `scripts/modeling/train_incident_outcomes.py` - 学習・推論スクリプト
- `scripts/sql/bq_phase_c_incident_outcomes.sql` - BigQueryビュー・テーブル定義

**機能:**
- ロジスティック回帰モデル（24時間以内鎮火確率予測）
- CoxPHサバイバルモデル（TTR予測）
- BigQueryへの予測結果書き込み

**使用方法:**
```bash
python scripts/modeling/train_incident_outcomes.py \
  --project_id viewpers \
  --dataset viewpers.salesguard_alerts \
  --model_version 20250101 \
  --write \
  --limit 1000
```

---

### ✅ フェーズD: 返信品質スコア & 類似事例検索

**実装ファイル:**
- `scripts/modeling/score_reply_quality.py` - 品質スコアリング
- `scripts/modeling/build_reply_embeddings.py` - 埋め込み生成
- `scripts/modeling/search_similar_cases.py` - 類似事例検索（Faiss）
- `scripts/sql/bq_phase_d_reply_quality.sql` - BigQueryビュー・テーブル定義

**APIエンドポイント:**
- `/api/ai/reply-quality` - 返信品質スコア取得
- `/api/ai/similar` - 類似事例検索（BigQueryベース）

**機能:**
- 返信品質スコアリング（丁寧さ、具体性、網羅性、構成、感情）
- 埋め込み生成（multilingual-e5-base）
- 類似事例検索（コサイン類似度）

**使用方法:**
```bash
# 品質スコアリング
python scripts/modeling/score_reply_quality.py \
  --project_id viewpers \
  --dataset viewpers.salesguard_alerts \
  --write \
  --limit 1000

# 埋め込み生成
python scripts/modeling/build_reply_embeddings.py \
  --project_id viewpers \
  --dataset viewpers.salesguard_alerts \
  --output_dir artifacts/reply_embeddings \
  --limit 1000

# 類似事例検索
python scripts/modeling/search_similar_cases.py \
  --project_id viewpers \
  --dataset viewpers.salesguard_alerts \
  --query_id <thread_id> \
  --top_k 5
```

---

### ✅ 検知ルール実装

**実装ファイル:**
- `app/api/detection-rules/route.ts` - 検知ルールAPI

**実装済みルール:**
1. **72時間放置検知** (`inactivity_72h`)
   - 最終アクティビティから72時間以上経過したスレッドを検知
   - スコア: 放置時間が長いほど高い（最大100）

2. **夜間返信率異常検知** (`night_reply_rate`)
   - 担当者の夜間返信率（22:00-6:00）が50%超で、ベースラインから20%以上上昇
   - スコア: 夜間返信率とベースラインからの差に基づく

3. **感情ダウン + 催促ワード検知** (`sentiment_urgency`)
   - 感情スコア < -0.3 かつ催促ワードを含むメッセージを検知
   - 催促ワード: 「進捗いかが」「お返事いただけますでしょうか」「確認させていただきたいのですが」など

4. **トーンダウン + 返信頻度変化検知** (`tone_frequency_drop`)
   - 過去30日と過去7日で感情スコアが0.2以上下降
   - かつ返信頻度が50%以下に低下

**API使用方法:**
```bash
# 全ルール実行
GET /api/detection-rules?limit=100

# 特定ルールのみ
GET /api/detection-rules?rule_type=inactivity_72h&limit=50
GET /api/detection-rules?rule_type=night_reply_rate
GET /api/detection-rules?rule_type=sentiment_urgency
GET /api/detection-rules?rule_type=tone_frequency_drop
```

---

### ✅ 動作確認用テストスクリプト

**実装ファイル:**
- `scripts/test_analysis_models.py` - 統合テストスクリプト

**使用方法:**
```bash
# 全テスト実行
python scripts/test_analysis_models.py --test all

# 個別テスト
python scripts/test_analysis_models.py --test phase_c
python scripts/test_analysis_models.py --test phase_d
python scripts/test_analysis_models.py --test detection_rules

# データ制限と書き込みスキップ
python scripts/test_analysis_models.py --test all --limit 100 --no_write
```

---

## 実装状況マップ

| 項目 | 実装状況 | ファイル | 備考 |
|------|---------|---------|------|
| フェーズC: 学習スクリプト | ✅ | `scripts/modeling/train_incident_outcomes.py` | 完全実装 |
| フェーズC: SQL定義 | ✅ | `scripts/sql/bq_phase_c_incident_outcomes.sql` | 完全実装 |
| フェーズD: 品質スコアリング | ✅ | `scripts/modeling/score_reply_quality.py` | 完全実装 |
| フェーズD: 埋め込み生成 | ✅ | `scripts/modeling/build_reply_embeddings.py` | 完全実装（sentence-transformersオプション） |
| フェーズD: 類似事例検索 | ✅ | `scripts/modeling/search_similar_cases.py` | 完全実装（Faissオプション） |
| フェーズD: SQL定義 | ✅ | `scripts/sql/bq_phase_d_reply_quality.sql` | 完全実装 |
| API: 返信品質取得 | ✅ | `app/api/ai/reply-quality/route.ts` | 完全実装 |
| API: 類似事例検索 | ✅ | `app/api/ai/similar/route.ts` | BigQueryベース実装 |
| 検知ルール: 72h放置 | ✅ | `app/api/detection-rules/route.ts` | 完全実装 |
| 検知ルール: 夜間返信率 | ✅ | `app/api/detection-rules/route.ts` | 完全実装 |
| 検知ルール: 感情+催促 | ✅ | `app/api/detection-rules/route.ts` | 完全実装 |
| 検知ルール: トーン+頻度 | ✅ | `app/api/detection-rules/route.ts` | 完全実装 |
| テストスクリプト | ✅ | `scripts/test_analysis_models.py` | 完全実装 |

---

## 次のステップ

### 1. BigQueryビューの作成
```bash
# フェーズC
bq query --use_legacy_sql=false < scripts/sql/bq_phase_c_incident_outcomes.sql

# フェーズD
bq query --use_legacy_sql=false < scripts/sql/bq_phase_d_reply_quality.sql
```

### 2. モデル学習の実行
```bash
# フェーズC: 学習と推論
python scripts/modeling/train_incident_outcomes.py \
  --project_id viewpers \
  --dataset viewpers.salesguard_alerts \
  --model_version $(date +%Y%m%d) \
  --write

# フェーズD: 品質スコアリング
python scripts/modeling/score_reply_quality.py \
  --project_id viewpers \
  --dataset viewpers.salesguard_alerts \
  --write

# フェーズD: 埋め込み生成
python scripts/modeling/build_reply_embeddings.py \
  --project_id viewpers \
  --dataset viewpers.salesguard_alerts \
  --output_dir artifacts/reply_embeddings
```

### 3. 動作確認
```bash
# 統合テスト
python scripts/test_analysis_models.py --test all

# API動作確認
curl "http://localhost:3000/api/detection-rules?rule_type=inactivity_72h&limit=5"
curl "http://localhost:3000/api/ai/reply-quality?thread_id=<thread_id>"
curl "http://localhost:3000/api/ai/similar?thread_id=<thread_id>&limit=3"
```

### 4. 運用化

**スケジュール設定:**
- フェーズC学習: 週次（Cloud Run Job / Composer）
- フェーズDスコアリング: 週次
- フェーズD埋め込み更新: 隔週
- 検知ルール: 日次（API呼び出し or バッチ）

**監視指標:**
- モデル性能: ROC-AUC、C-index、Calibration
- 品質スコア分布: 平均、中央値、P90
- 検知ルール: 検知件数、スコア分布、False Positive率

---

## 注意事項

1. **依存パッケージ:**
   - Python: `google-cloud-bigquery`, `pandas`, `scikit-learn`, `lifelines`, `numpy`
   - オプション: `sentence-transformers` (埋め込み生成), `faiss-cpu` (高速検索)

2. **BigQuery権限:**
   - `roles/bigquery.dataEditor` - テーブル書き込み
   - `roles/bigquery.jobUser` - クエリ実行

3. **データ要件:**
   - `vw_incident_lifecycle` - フェーズCに必要
   - `unified_email_messages` - 全機能に必要
   - `alerts_v2_scored` - 検知ルールに必要

---

## 更新履歴

- 2025-01-XX: 全機能実装完了
  - フェーズC: インシデント結果予測
  - フェーズD: 返信品質スコア & 類似事例検索
  - 検知ルール: 4つのルール実装
  - テストスクリプト: 統合テスト実装


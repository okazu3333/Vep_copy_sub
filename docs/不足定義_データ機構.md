# 不足部分 定義（データ機構）

## 1. 評価用ラベルテーブル
- 目的: Precision/Recall、TopN 的中率の算出。
- DDL
```sql
CREATE TABLE IF NOT EXISTS `viewpers.salesguard_alerts.alerts_labels` (
  message_id STRING NOT NULL,
  thread_id STRING,
  rule_id STRING,              -- 対象ルール（任意）
  importance STRING,           -- 'high'|'medium'|'low'
  is_true_positive BOOL,       -- その検知が正しかったか
  notes STRING,
  labeled_by STRING,
  labeled_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP()
)
PARTITION BY DATE(labeled_at);
```
- 運用: 最小50–100件を投入。週次で追記。

## 2. スケジュールクエリ（再計算）
- 日次（00:30 JST）
  - 再作成/更新: `vw_time_features`, `vw_thread_activity`, `vw_sentiment_trends`, `vw_reply_frequency`
  - ルール: `det_rule_inactivity_72h`, `det_rule_tone_down_and_inquiry`, `det_rule_night_reply_anomaly`, `det_rule_tone_and_freq_drop`
  - ライフサイクル: `vw_incident_lifecycle`, `vw_person_health`
- 週次（Sun 01:00 JST）
  - 評価レポート集計（P/R/TopN/TTR/>72h/night）→ `weekly_metrics` テーブルへ書出し

## 3. 本文表示の PII マスキング / HTML サニタイズ
- 方針: 既定はサニタイズ済プレーン表示。PIIは既定でマスク、トグルで解除可（管理者のみ）。
- ルール（正規表現の例）
  - email: `[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}` → `***@***`
  - phone: `\\+?\\d[\\d -]{8,}\\d` → `***-****-****`
  - address/zip: `\\d{3}-\\d{4}` → `***-****`
- HTML: すべてのタグを除去し、リンク/画像は無効化（アンカーはテキスト化）。

## 4. フレーズ辞書の保管場所
- テーブル方式（推奨）
```sql
CREATE TABLE IF NOT EXISTS `viewpers.salesguard_alerts.keyword_dictionary` (
  phrase STRING NOT NULL,
  category STRING,           -- 'inquiry'|'churn'|'urgent'|'complaint'|'pricing' etc
  weight FLOAT64 DEFAULT 1.0,
  locale STRING DEFAULT 'ja',
  enabled BOOL DEFAULT TRUE,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP()
)
PARTITION BY DATE(updated_at);
```
- 例行追加: 週次で見逃しからフレーズを追加。

## 5. 監査ログ（本文閲覧）
- 目的: 誰がいつどの本文を開いたかの追跡。
- 方式: アプリ側で `audit_view_body` に記録。
```sql
CREATE TABLE IF NOT EXISTS `viewpers.salesguard_alerts.audit_view_body` (
  viewer STRING,           -- email or user id
  message_id STRING,
  thread_id STRING,
  view_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP(),
  reason STRING            -- support|investigation|training etc
)
PARTITION BY DATE(view_at);
```

## 6. 週次レポート出力
- 出力先: `viewpers.salesguard_alerts.weekly_metrics`
- 列案: `week_start, precision_overall, recall_overall, top100_precision, ttr_first_p50, ttr_resolve_p50, over72h_count, night_ratio_team`
- 実行: 週次スケジュールクエリで再計算。

## 7. 最終スコア統合の重み（暫定）
- ルール寄与: inactivity +15, sentiment×inquiry +20, night_anomaly +10, tone×freq_drop +15
- 減点: positive sentiment (recent > 0.2) -10
- クリップ: 0–100（A≥80, B≥60, C≥30）
- 保存: `vw_alerts_scored_bq` で算出（ビュー時に合成、将来はテーブル化）

---
更新履歴
- 2025-10-24 初稿



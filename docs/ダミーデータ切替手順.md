# ダミーデータ切替手順

## 1. ダミーデータセットの作成
以下のコマンドで `salesguard_alerts_dummy` データセットを作成し、サンプルデータを投入済みです。

```bash
bq --project_id=viewpers mk --dataset --location=asia-northeast1 salesguard_alerts_dummy
bq query --use_legacy_sql=false --project_id=viewpers < scripts/sql/bq_seed_dummy_data.sql
```

これにより、以下のテーブルが生成されています。
- `viewpers.salesguard_alerts_dummy.unified_email_messages`
- `viewpers.salesguard_alerts_dummy.alerts_v2_scored`

## 2. 各種ビュー/テーブルの再構築
フェーズA〜Dのビューもダミーデータセットに複製済みです。再実行が必要な場合は、`salesguard_alerts` を `salesguard_alerts_dummy` に置換して実行します。

```bash
sed 's/salesguard_alerts/salesguard_alerts_dummy/g' scripts/sql/bq_setup_detection.sql \
  | bq query --use_legacy_sql=false --allow_large_results --project_id=viewpers

sed 's/salesguard_alerts/salesguard_alerts_dummy/g' scripts/sql/bq_phase_c_incident_outcomes.sql \
  | bq query --use_legacy_sql=false --allow_large_results --project_id=viewpers

sed 's/salesguard_alerts/salesguard_alerts_dummy/g' scripts/sql/bq_phase_d_reply_quality.sql \
  | bq query --use_legacy_sql=false --allow_large_results --project_id=viewpers
```

## 3. Python スクリプト側のデータセット切り替え
フェーズC/Dのスクリプトは `--dataset` 引数または環境変数 `SA_ALERTS_DATASET` で参照先を切り替えられます。

### 例: フェーズC モデル学習
```bash
python scripts/modeling/train_incident_outcomes.py \
  --project_id viewpers \
  --dataset viewpers.salesguard_alerts_dummy \
  --model_version dummy-20251030 \
  --limit 200
```

### 例: フェーズD 品質スコア算出
```bash
python scripts/modeling/score_reply_quality.py \
  --project_id viewpers \
  --dataset viewpers.salesguard_alerts_dummy \
  --model_version dummy-20251030 \
  --limit 100
```

### 例: 類似事例埋め込み生成
```bash
python scripts/modeling/build_reply_embeddings.py \
  --project_id viewpers \
  --dataset viewpers.salesguard_alerts_dummy \
  --model_name intfloat/multilingual-e5-base \
  --limit 500
```

環境変数として切り替える場合は以下を設定してください。
```bash
export SA_ALERTS_DATASET=viewpers.salesguard_alerts_dummy
```

## 4. フロントエンドのモック切替
- `.env.local` などに `NEXT_PUBLIC_USE_DUMMY_ALERTS=1` を設定すると、`/alerts` 画面は `data/mock/dummyAlerts.ts` のモックデータを表示します。
- 実データに戻す場合は `NEXT_PUBLIC_USE_DUMMY_ALERTS=0` にするか、変数を削除してください。
- 類似事例API（`/api/ai/similar`）もダミーデータを返すスタブを提供しています（例: `/api/ai/similar?thread_id=thread-002`）。

## 5. 元データセットへの復帰
元の本番データを利用したい場合は、`--dataset viewpers.salesguard_alerts` を指定するか、`SA_ALERTS_DATASET` 環境変数を未設定にします。ビューやテーブルは既存のものを再利用できます。
